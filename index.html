<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Substrate Population Explorer v6.9.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --danger: #FF3333; --warning: #FFFF00; --safe: #00FF88; --successor: #FF9900; --bg: #000000; --panel: #111; --text: #FFFFFF; --accent: #00FFFF; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; font-size: 14px; }
        .terminal-wrapper { max-width: 1700px; margin: auto; display: grid; grid-template-columns: 420px 1fr; gap: 25px; }
        @media (max-width: 1200px) { .terminal-wrapper { grid-template-columns: 1fr; } }
        .panel { background: var(--panel); border: 2px solid #333; padding: 20px; border-radius: 12px; }
        .card { background: #000; border: 1px solid #444; padding: 15px; margin-bottom: 15px; border-radius: 6px; }
        .label { font-size: 0.7rem; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; font-weight: 900; }
        .val-badge { font-family: monospace; color: #FFF; font-size: 0.85rem; background: #222; padding: 2px 6px; border-radius: 3px; }
        input[type=range] { width: 100%; height: 8px; border-radius: 5px; background: #333; outline: none; margin: 10px 0; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--accent), var(--danger)); height: 8px; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { height: 18px; width: 10px; background: #FFF; cursor: pointer; -webkit-appearance: none; margin-top: -5px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .t-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; font-weight: 900; font-size: 0.7rem; border-radius: 4px; }
        .t-btn.active { border-color: var(--safe); color: var(--safe); background: #051a05; }
        .s-btn { background: #111; border: 1px solid #333; color: #aaa; padding: 10px; font-size: 0.7rem; cursor: pointer; font-weight: bold; border-radius: 4px; margin: 2px; }
        .s-btn.active-preset { border-color: var(--accent); background: #002222; color: #fff; box-shadow: 0 0 10px rgba(0,255,255,0.2); }
        #toast { visibility: hidden; min-width: 250px; background-color: var(--accent); color: #000; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; border: 2px solid #fff; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .meter { height: 10px; background: #222; margin: 10px 0; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        .meter-fill { height: 100%; transition: 0.8s; }
        .export-btn { margin-top: 10px; width: 100%; padding: 12px; background: #222; border: 1px solid var(--accent); color: var(--accent); font-weight: 900; cursor: pointer; border-radius: 6px; }
    </style>
</head>
<body>

<div id="toast">LINK COPIED TO CLIPBOARD</div>

<div class="terminal-wrapper">
    <aside class="panel">
        <div class="label">Geopolitical Registry</div>
        <select id="country-select" onchange="update()" style="width:100%; background:#000; color:#fff; padding:10px; border:1px solid #444; margin-bottom:20px;"></select>

        <div class="label">Presets</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom:15px;">
            <button class="s-btn" id="p-collapse" onclick="applyPreset('collapse')">Collapse</button>
            <button class="s-btn" id="p-convergence" onclick="applyPreset('convergence')">Integration</button>
            <button class="s-btn" id="p-exit" onclick="applyPreset('exit')">Inst. Exit</button>
            <button class="s-btn" id="p-stable" onclick="applyPreset('stable')">Continuity</button>
        </div>

        <div class="label">Succession Threshold ($\psi$)</div>
        <div class="btn-group">
            <button class="t-btn active" id="t21" onclick="setThreshold(2.1)">2.1 (Deterministic)</button>
            <button class="t-btn" id="t27" onclick="setThreshold(2.7)">2.7 (Stochastic)</button>
        </div>

        <div class="label">Substrate Exhaustion Matrix</div>
        <div class="card">
            <div style="display:flex; justify-content:space-between;"><span class="label">Axiological Exhaustion</span><span id="aei-v" class="val-badge">0%</span></div>
            <input type="range" id="aei-s" min="0" max="1" step="0.05" value="0.3" oninput="update()">
            <div style="display:flex; justify-content:space-between;"><span class="label">Resource Scarcity</span><span id="scar-v" class="val-badge">0%</span></div>
            <input type="range" id="scar-s" min="0" max="1" step="0.05" value="0.2" oninput="update()">
            <div style="display:flex; justify-content:space-between;"><span class="label">Wealth Concentration</span><span id="wealth-v" class="val-badge">0%</span></div>
            <input type="range" id="wealth-s" min="0.1" max="0.9" step="0.05" value="0.4" oninput="update()">
        </div>

        <div class="label">Systemic Levers</div>
        <div class="card">
            <div style="display:flex; justify-content:space-between;"><span class="label">Migration Intensity</span><span id="mig-v" class="val-badge">0%</span></div>
            <input type="range" id="mig-s" min="0" max="1" step="0.05" value="0.5" oninput="update()">
            <div style="display:flex; justify-content:space-between;"><span class="label">Convergence (Î»)</span><span id="conv-v" class="val-badge">0%</span></div>
            <input type="range" id="conv-s" min="0" max="1" step="0.05" value="0.5" oninput="update()">
            <div style="display:flex; justify-content:space-between;"><span class="label">Legacy Debt</span><span id="debt-v" class="val-badge">0%</span></div>
            <input type="range" id="debt-s" min="0" max="300" step="5" value="80" oninput="update()">
        </div>

        <button id="export-btn" class="export-btn">SHARE SCENARIO (URL)</button>
    </aside>

    <main class="panel">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 id="country-display" style="margin:0; font-size:2.8rem; letter-spacing:-1.5px;">Select Country</h1>
                <div id="shift-status" style="font-weight:900; font-size:0.85rem; color:var(--safe);">STABLE SUBSTRATE</div>
            </div>
            <div style="text-align:right;">
                <div class="label">Persistence (G8)</div>
                <div id="gsp-val" style="font-size:3rem; font-weight:900;">--%</div>
            </div>
        </div>
        <div style="height: 440px; margin-top: 20px;"><canvas id="mainChart"></canvas></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top:20px;">
            <div class="card" style="text-align:center;">
                <div class="label">Friction Drag</div>
                <div id="friction-val" style="font-size:2rem; font-weight:900; color:var(--danger);">0%</div>
                <div id="exit-status" style="font-size:0.75rem; font-weight:900; margin-top:5px;">EXIT: NONE</div>
            </div>
            <div class="card">
                <div class="label">Social Trust</div>
                <div class="meter"><div id="trust-fill" class="meter-fill" style="background:var(--safe)"></div></div>
                <div class="label">Complexity</div>
                <div class="meter"><div id="comp-fill" class="meter-fill" style="background:var(--accent)"></div></div>
            </div>
            <div class="card" style="text-align:center;">
                <div class="label">Replace Ratio</div>
                <div id="replace-ratio" style="font-size:2rem; font-weight:900; color:var(--successor);">0x</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <p style="font-size:0.85rem; color:#666;">$$H_{n+1} = H_n \cdot \left( \frac{TFR_{init} \cdot (1 - AEI)}{\psi} \right)$$</p>
        </div>
    </main>
</div>

<script>
let currentThreshold = 2.1;
const registry = {
    "AUS": { name: "Australia", tfr: 1.42, mig: 0.55, coh: 0.70, debt: 45 },
    "CAN": { name: "Canada", tfr: 1.28, mig: 0.80, coh: 0.65, debt: 107 },
    "CHN": { name: "China", tfr: 1.00, mig: 0.01, coh: 0.88, debt: 90 },
    "FRA": { name: "France", tfr: 1.56, mig: 0.42, coh: 0.69, debt: 112 },
    "GER": { name: "Germany", tfr: 1.45, mig: 0.55, coh: 0.68, debt: 65 },
    "ISR": { name: "Israel", tfr: 2.91, mig: 0.05, coh: 0.89, debt: 62 },
    "ITA": { name: "Italy", tfr: 1.21, mig: 0.40, coh: 0.72, debt: 140 },
    "JPN": { name: "Japan", tfr: 1.25, mig: 0.02, coh: 0.84, debt: 260 },
    "KOR": { name: "South Korea", tfr: 0.72, mig: 0.03, coh: 0.45, debt: 55 },
    "UK":  { name: "United Kingdom", tfr: 1.52, mig: 0.52, coh: 0.68, debt: 102 },
    "USA": { name: "United States", tfr: 1.58, mig: 0.55, coh: 0.72, debt: 125 }
};

let chart;
function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000); }
function setThreshold(val) { currentThreshold = val; document.getElementById('t21').classList.toggle('active', val === 2.1); document.getElementById('t27').classList.toggle('active', val === 2.7); update(); }
function applyPreset(type) {
    const p = {
        collapse: { aei: 0.8, scar: 0.7, wealth: 0.8, mig: 0.2, conv: 0.4, debt: 160 },
        convergence: { aei: 0.2, scar: 0.1, wealth: 0.3, mig: 0.5, conv: 0.85, debt: 50 },
        exit: { aei: 0.5, scar: 0.6, wealth: 0.7, mig: 0.8, conv: 0.2, debt: 220 },
        stable: { aei: 0.1, scar: 0.05, wealth: 0.2, mig: 0.1, conv: 0.8, debt: 30 }
    }[type];
    Object.keys(p).forEach(k => document.getElementById(k+'-s').value = p[k]);
    document.querySelectorAll('.s-btn').forEach(b => b.classList.remove('active-preset'));
    if(document.getElementById('p-'+type)) document.getElementById('p-'+type).classList.add('active-preset');
    update();
}

function update() {
    const sel = document.getElementById('country-select');
    const c = registry[sel.value];
    // FIX: Show Full Name
    document.getElementById('country-display').innerText = sel.options[sel.selectedIndex].text;
    const i = {
        aei: parseFloat(document.getElementById('aei-s').value),
        scar: parseFloat(document.getElementById('scar-s').value),
        wealth: parseFloat(document.getElementById('wealth-s').value),
        mig: parseFloat(document.getElementById('mig-s').value),
        conv: parseFloat(document.getElementById('conv-s').value),
        debt: parseFloat(document.getElementById('debt-s').value)
    };
    ['aei','scar','wealth','mig','conv','debt'].forEach(k => {
        const val = document.getElementById(k+'-s').value;
        document.getElementById(k+'-v').innerText = (k === 'debt' ? val : Math.round(val*100)) + '%';
        document.getElementById(k+'-s').setAttribute('aria-valuenow', k === 'debt' ? val : Math.round(val*100));
    });
    let hP = [1.0], sP = [0.0], crossover = -1;
    const hTFR = c.tfr * (1 - i.aei*0.5);
    for(let j=1; j<=8; j++) {
        hP.push(hP[j-1] * (hTFR / currentThreshold));
        sP.push((sP[j-1] * 1.05) + (i.mig * 0.12));
        if(crossover === -1 && sP[j] > hP[j]) crossover = j;
    }
    const fDrag = (i.debt / 40) + (i.scar * 8) + ((1-i.conv) * 5);
    document.getElementById('friction-val').innerText = fDrag.toFixed(1) + '%';
    document.getElementById('exit-status').innerText = fDrag > 4.5 ? "EXIT: ACTIVE" : "EXIT: NONE";
    document.getElementById('gsp-val').innerText = (hP[8]*100).toFixed(1) + "%";
    document.getElementById('replace-ratio').innerText = (sP[8]/(hP[8]+0.01)).toFixed(1) + "x";
    document.getElementById('shift-status').innerText = crossover > -1 ? `CROSSOVER: GEN ${crossover}` : "STABLE SUBSTRATE";
    document.getElementById('trust-fill').style.width = Math.max(5, 100 - ( (1-i.conv)*60 + i.scar*20)) + '%';
    document.getElementById('comp-fill').style.width = Math.max(5, 100 - (i.debt/3.5)) + '%';
    chart.data.datasets[0].data = hP;
    chart.data.datasets[1].data = sP;
    chart.update();
}

document.getElementById('export-btn').onclick = () => {
    const s = { c: document.getElementById('country-select').value, a: document.getElementById('aei-s').value, t: currentThreshold };
    navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?s=' + btoa(JSON.stringify(s)));
    showToast("LINK COPIED TO CLIPBOARD");
};

function init() {
    const sel = document.getElementById('country-select');
    Object.keys(registry).sort().forEach(k => sel.add(new Option(registry[k].name, k)));
    sel.value = "USA";
    chart = new Chart(document.getElementById('mainChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: ['G0','G1','G2','G3','G4','G5','G6','G7','G8'],
            datasets: [
                { label: 'Heritage Substrate', data: [], borderColor: '#00FF88', tension: 0.3, borderWidth: 4 },
                { label: 'Successor Substrate', data: [], borderColor: '#FF9900', borderDash: [5,5], tension: 0.3, borderWidth: 3 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#FFF', font: { size: 14, weight: '600' }, padding: 25 } } },
            scales: { y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666' } }, x: { grid: { color: '#222' }, ticks: { color: '#666' } } }
        }
    });
    update();
}
init();
</script>
</body>
</html>
